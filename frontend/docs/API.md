# API Integration Guide

## Overview

Pesti integrates with a backend API for authentication, data retrieval, and forecasting. This document describes the API integration patterns and endpoints.

## API Client

The application uses a centralized API client located at `src/shared/lib/api-client.ts`.

### Configuration

```typescript
// Environment variable
VITE_API_BASE_URL=http://localhost:8000
```

### Usage

```typescript
import { apiClient } from "@/shared/lib/api-client";

// GET request
const data = await apiClient.get("/endpoint");

// POST request
const result = await apiClient.post("/endpoint", payload);
```

## Authentication Endpoints

### Login

**POST** `/auth/login`

**Request Body**:

```json
{
  "username": "string",
  "password": "string"
}
```

**Response**:

```json
{
  "success": true,
  "token": "jwt-token",
  "user": {
    "id": "string",
    "username": "string",
    "role": "Administrator" | "Researcher" | "Field Manager"
  }
}
```

### Registration

**POST** `/auth/register`

**Request Body**:

```json
{
  "username": "string",
  "email": "string",
  "password": "string",
  "role": "Researcher" | "Field Manager"
}
```

**Response**:

```json
{
  "success": true,
  "message": "Registration pending approval"
}
```

### Logout

**POST** `/auth/logout`

**Headers**: `Authorization: Bearer <token>`

## Dashboard Endpoints

### Get Observations

**GET** `/dashboard/observations`

**Query Parameters**:

- `year`: number (optional)
- `season`: "Dry" | "Wet" | "All" (optional)
- `pestType`: "Black Rice Bug" | "All" (optional)
- `startDate`: ISO date string (optional)
- `endDate`: ISO date string (optional)

**Response**:

```json
{
  "success": true,
  "data": [
    {
      "id": "string",
      "date": "YYYY-MM-DD",
      "pestType": "Black Rice Bug",
      "count": 25,
      "threshold": 50,
      "aboveThreshold": false,
      "season": "Dry",
      "fieldStage": "Reproductive"
    }
  ]
}
```

### Get Forecasts

**GET** `/dashboard/forecast`

**Response**:

```json
{
  "success": true,
  "data": {
    "forecasted": {
      "future_dates": {
        "0": "2024-12-18",
        "1": "2024-12-19"
      },
      "forecast": {
        "0": 45,
        "1": 52
      },
      "ci_lower": {
        "0": 38,
        "1": 44
      },
      "ci_upper": {
        "0": 52,
        "1": 60
      }
    }
  }
}
```

### Get KPIs

**GET** `/dashboard/kpis`

**Response**:

```json
{
  "success": true,
  "data": {
    "totalObservations": 1250,
    "averagePestCount": 12.5,
    "percentAboveThreshold": 15.2,
    "totalActionsTaken": 189,
    "actionRate": 15.1
  }
}
```

## User Management Endpoints

### Get User Profile

**GET** `/user/profile`

**Headers**: `Authorization: Bearer <token>`

**Response**:

```json
{
  "success": true,
  "data": {
    "id": "string",
    "username": "string",
    "email": "string",
    "role": "Administrator",
    "photoUrl": "string" | null
  }
}
```

### Update User Profile

**PUT** `/user/profile`

**Headers**: `Authorization: Bearer <token>`

**Request Body**:

```json
{
  "username": "string",
  "email": "string",
  "photoUrl": "string" | null
}
```

## Admin Endpoints

### Get Pending Approvals

**GET** `/admin/pending-approvals`

**Headers**: `Authorization: Bearer <token>` (Admin only)

**Response**:

```json
{
  "success": true,
  "data": [
    {
      "id": "string",
      "username": "string",
      "email": "string",
      "role": "Researcher",
      "requestedAt": "2024-12-17T10:00:00Z"
    }
  ]
}
```

### Approve User

**POST** `/admin/approve/:userId`

**Headers**: `Authorization: Bearer <token>` (Admin only)

**Response**:

```json
{
  "success": true,
  "message": "User approved successfully"
}
```

### Reject User

**POST** `/admin/reject/:userId`

**Headers**: `Authorization: Bearer <token>` (Admin only)

**Request Body**:

```json
{
  "reason": "string"
}
```

## Error Handling

### Error Response Format

```json
{
  "success": false,
  "error": "Error message",
  "code": "ERROR_CODE"
}
```

### HTTP Status Codes

- **200**: Success
- **201**: Created
- **400**: Bad Request
- **401**: Unauthorized
- **403**: Forbidden
- **404**: Not Found
- **500**: Internal Server Error

### Error Handling in Code

```typescript
try {
  const response = await apiClient.get("/endpoint");
  if (response.success) {
    // Handle success
  }
} catch (error) {
  // Handle error
  console.error("API Error:", error);
}
```

## Mock Data Mode

When `VITE_USE_MOCKS=true`, the application uses mock data generators instead of API calls:

- **Observations**: Generated by `pests.mock.ts`
- **Forecasts**: Generated by `forecasting.mock.ts`
- **Alerts**: Static mock data in `data-service.ts`

Mock data is automatically used as a fallback if API calls fail.

## Authentication

### Token Management

- **Storage**: JWT tokens stored in Zustand state (memory)
- **Headers**: Automatically included in API requests
- **Refresh**: Implement token refresh logic as needed
- **Expiry**: Handle token expiry gracefully

### Protected Routes

Routes are protected at the component level:

```typescript
if (!user) {
  return <Login />;
}
```

## Rate Limiting

The backend may implement rate limiting. Handle rate limit errors:

```typescript
if (error.status === 429) {
  // Handle rate limit
  showError("Too many requests. Please try again later.");
}
```

## Best Practices

1. **Error Handling**: Always handle API errors gracefully
2. **Loading States**: Show loading indicators during API calls
3. **Caching**: Cache API responses when appropriate
4. **Retry Logic**: Implement retry for failed requests
5. **Type Safety**: Use TypeScript types for API responses
6. **Validation**: Validate API responses with Zod schemas

## Testing API Integration

### Mock API Responses

Use mock data for testing:

```typescript
// In tests
vi.mock("@/shared/lib/api-client", () => ({
  apiClient: {
    get: vi.fn(() => Promise.resolve({ success: true, data: mockData })),
  },
}));
```

### Integration Tests

Test API integration with mock servers or test endpoints.
